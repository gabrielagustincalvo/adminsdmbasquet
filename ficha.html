<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha del Jugador - Gesti√≥n Club üèÄ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        @media print {
            nav, .botonera-acciones, .solo-pantalla { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            html, body { background-color: white !important; height: auto !important; margin: 0 !important; padding: 0 !important; }
            .container, #area-pdf {
                max-width: 100% !important; width: 100% !important; padding: 0 !important; margin: 0 !important;
                background-color: transparent !important;
            }
            .card {
                border: 2px solid #000 !important; box-shadow: none !important; page-break-inside: avoid;
                margin-bottom: 0 !important; 
            }
            .solo-impresion { display: block !important; }
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">üèÄ Club Atl√©tico Sol de Mayo Basquet</a>
            <div class="d-flex align-items-center text-white">
                <a href="javascript:history.back()" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row justify-content-center">
            <div class="col-12">
                
                <div id="area-pdf" class="p-2 bg-white rounded">
                    <div class="solo-impresion text-center mb-3 mt-3">
                        <h2 class="fw-bold text-dark">üè• Ficha M√©dica de Emergencia</h2>
                        <p class="mb-0 text-muted">Club Atl√©tico - B√°squet</p>
                    </div>

                    <div class="card shadow-sm border-0 mb-4">
                        
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-3">
                            <h5 class="mb-0"><i class="bi bi-person-vcard"></i> Ficha Personal</h5>
                            <span id="f-rama" class="badge bg-light text-primary fs-6 px-3 py-2 rounded-pill shadow-sm">...</span>
                        </div>
                        
                        <div class="d-flex justify-content-center align-items-center mb-4 gap-3 mt-3">
                            <h2 id="f-nombre-completo" class="fw-bold text-dark mb-0">Cargando...</h2>
                            <button onclick="window.location.href='editar.html?id=' + idJugador" class="btn btn-outline-secondary btn-sm rounded-circle botonera-acciones" title="Editar Jugador">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button onclick="eliminarJugador()" class="btn btn-outline-danger btn-sm rounded-circle botonera-acciones" title="Eliminar Jugador">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </div>
                            
                        <div class="row g-3 mb-4 px-3">
                            <div class="col-4">
                                <div class="p-3 bg-light rounded border text-center">
                                    <small class="text-muted d-block text-uppercase fw-bold">DNI</small>
                                    <strong id="f-dni" class="fs-5">-</strong>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3 bg-light rounded border text-center">
                                    <small class="text-muted d-block text-uppercase fw-bold">Nacimiento</small>
                                    <strong id="f-fecha" class="fs-5">-</strong>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3 bg-light rounded border text-center">
                                    <small class="text-muted d-block text-uppercase fw-bold">Celular</small>
                                    <strong id="f-telefono" class="fs-5">-</strong>
                                </div>
                            </div>
                        </div>

                        <h5 class="text-secondary border-bottom pb-2 mt-4 px-3"><i class="bi bi-telephone-fill text-danger"></i> Contacto de Emergencia</h5>
                        <div class="mb-4 p-3 mx-3 bg-light rounded border">
                            <div class="row g-3">
                                <div class="col-6">
                                    <small class="text-muted d-block">Nombre del contacto</small>
                                    <strong id="f-emergencia-nombre" class="fs-6">-</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Tel√©fono de emergencia</small>
                                    <strong id="f-emergencia-tel" class="fs-6">-</strong>
                                </div>
                            </div>
                        </div>

                        <h5 class="text-secondary border-bottom pb-2 mt-4 px-3"><i class="bi bi-heart-pulse-fill text-danger"></i> Historial M√©dico</h5>
                        <div class="row g-3 px-3 mb-4">
                            <div class="col-6">
                                <div class="p-3 bg-danger bg-opacity-10 rounded border border-danger text-center h-100">
                                    <small class="text-danger fw-bold d-block text-uppercase">Grupo Sangu√≠neo</small>
                                    <strong id="f-grupo" class="fs-3">-</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-warning bg-opacity-10 rounded border border-warning text-center h-100">
                                    <small class="text-warning text-darken fw-bold d-block text-uppercase" style="color: #b38000!important;">Alergias</small>
                                    <strong id="f-alergias" class="fs-5">-</strong>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-3 bg-light rounded border">
                                    <small class="text-muted fw-bold d-block mb-1">Lesiones Previas:</small>
                                    <p id="f-lesiones" class="mb-0">-</p>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-3 bg-light rounded border">
                                    <small class="text-muted fw-bold d-block mb-1">Cirug√≠as:</small>
                                    <p id="f-cirugias" class="mb-0">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> 
                
                <h5 class="text-secondary border-bottom pb-2 mt-4 solo-pantalla"><i class="bi bi-calendar-check-fill text-success"></i> Seguimiento de Asistencia</h5>
                <div class="row g-3 mb-4 solo-pantalla">
                    <div class="col-12">
                        <div class="p-3 bg-light rounded border border-info shadow-sm">
                            <h6 class="text-info fw-bold mb-2"><i class="bi bi-bar-chart-line-fill"></i> Reporte General</h6>
                            <p id="f-reporte-texto" class="mb-0 text-dark">Cargando m√©tricas de asistencia...</p>
                        </div>
                    </div>
                    <div class="col-md-6 mt-3">
                        <label class="form-label fw-bold text-muted small">Buscar asistencia de un d√≠a espec√≠fico:</label>
                        <div class="input-group shadow-sm">
                            <input type="date" id="buscador-fecha-asis" class="form-control border-secondary">
                            <button class="btn btn-secondary fw-bold" onclick="buscarAsistenciaPorDia()">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 mt-3">
                        <label class="form-label fw-bold text-muted small">Estado del jugador en esa fecha:</label>
                        <div id="resultado-busqueda-dia" class="p-2 border border-secondary rounded bg-white text-center d-flex flex-column justify-content-center" style="min-height: 38px;">
                            <span class="text-muted small">Seleccion√° una fecha para ver el estado.</span>
                        </div>
                    </div>
                </div>

                <h5 class="text-secondary border-bottom pb-2 mt-4 solo-pantalla d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-bandaid-fill text-primary"></i> Historial Kinesiol√≥gico</span>
                    <button class="btn btn-sm btn-primary fw-bold" id="btn-agregar-kine" data-bs-toggle="modal" data-bs-target="#modalKine">
                        <i class="bi bi-plus-lg"></i> Agregar Sesi√≥n
                    </button>
                </h5>
                <div class="row g-3 mb-4 solo-pantalla">
                    <div class="col-12">
                        <div class="table-responsive bg-white rounded border shadow-sm" style="max-height: 250px; overflow-y: auto;">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Motivo / Lesi√≥n</th>
                                        <th>Tratamiento</th>
                                        <th>Profesional</th>
                                        <th class="text-center">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-kinesiologia">
                                    <tr><td colspan="5" class="text-center text-muted py-3">Cargando historial...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                    
                <div id="botonera" class="mt-2 text-center d-flex justify-content-center gap-3 flex-wrap botonera-acciones">
                    <button onclick="window.print()" class="btn btn-secondary shadow-sm px-4">
                        <i class="bi bi-printer"></i> Imprimir
                    </button>
                    <button onclick="generarPDFyWhatsApp()" class="btn btn-success shadow-sm px-4">
                        <i class="bi bi-whatsapp"></i> Enviar PDF
                    </button>
                    <button onclick="compartirEmail()" class="btn btn-primary shadow-sm px-4">
                        <i class="bi bi-envelope"></i> Correo
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="modalKine" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-bandaid"></i> Nuevo Registro Kinesiol√≥gico</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-kine">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Fecha de Sesi√≥n</label>
                            <input type="date" id="k-fecha" class="form-control bg-light" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Motivo / Lesi√≥n</label>
                            <input type="text" id="k-motivo" class="form-control border-primary" placeholder="Ej: Esguince tobillo derecho" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Tratamiento Realizado</label>
                            <textarea id="k-tratamiento" class="form-control bg-light" rows="2" placeholder="Ej: Magnetoterapia, masajes..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Observaciones / Evoluci√≥n (Opcional)</label>
                            <textarea id="k-observaciones" class="form-control bg-light" rows="2" placeholder="Ej: Reposo por 48hs"></textarea>
                        </div>
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary fw-bold">Guardar Registro</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditarKine" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square"></i> Editar Sesi√≥n de Kinesiolog√≠a</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-editar-kine">
                        <input type="hidden" id="edit-k-id">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Fecha de Sesi√≥n</label>
                            <input type="date" id="edit-k-fecha" class="form-control bg-light" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Motivo / Lesi√≥n</label>
                            <input type="text" id="edit-k-motivo" class="form-control border-warning" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Tratamiento Realizado</label>
                            <textarea id="edit-k-tratamiento" class="form-control bg-light" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Observaciones / Evoluci√≥n (Opcional)</label>
                            <textarea id="edit-k-observaciones" class="form-control bg-light" rows="2"></textarea>
                        </div>
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-dark fw-bold">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SEGURIDAD ---
        if (!sessionStorage.getItem('usuarioLogueado')) {
            window.location.href = 'login.html';
        }

        const urlParams = new URLSearchParams(window.location.search);
        const idJugador = urlParams.get('id');
        let jugadorActual = null;
        let historialAsistencia = [];
        let historialKine = []; // Memoria global para kinesiologia

        // --- 2. CARGAR FICHA PRINCIPAL ---
        async function cargarFicha() {
            try {
                const respuesta = await fetch(`http://localhost:3000/jugadores/${idJugador}`);
                jugadorActual = await respuesta.json();

                document.getElementById('f-nombre-completo').innerText = `${jugadorActual.nombre} ${jugadorActual.apellido}`;
                document.getElementById('f-dni').innerText = jugadorActual.dni;
                
                if(jugadorActual.fecha_nacimiento){
                    const fecha = new Date(jugadorActual.fecha_nacimiento);
                    fecha.setMinutes(fecha.getMinutes() + fecha.getTimezoneOffset()); 
                    document.getElementById('f-fecha').innerText = fecha.toLocaleDateString('es-AR');
                }
                
                document.getElementById('f-telefono').innerText = jugadorActual.telefono || '-';
                document.getElementById('f-emergencia-nombre').innerText = jugadorActual.contacto_emergencia_nombre || '-';
                document.getElementById('f-emergencia-tel').innerText = jugadorActual.contacto_emergencia_tel || '-';
                
                document.getElementById('f-grupo').innerText = jugadorActual.grupo_sanguineo || 'No espec.';
                document.getElementById('f-alergias').innerText = jugadorActual.alergias || 'Ninguna';
                document.getElementById('f-lesiones').innerText = jugadorActual.lesiones || 'Ninguna';
                document.getElementById('f-cirugias').innerText = jugadorActual.cirugias || 'Ninguna';
                
                const rama = jugadorActual.rama || 'Masculino';
                const badgeRama = document.getElementById('f-rama');
                badgeRama.innerText = rama;
                if (rama === 'Femenino') badgeRama.classList.replace('text-primary', 'text-danger');

                // Cargar estad√≠sticas
                try {
                    const resAsis = await fetch(`http://localhost:3000/asistencia/jugador/${idJugador}`);
                    historialAsistencia = await resAsis.json();
                    generarReporteAsistencia(); 
                } catch (e) {
                    document.getElementById('f-reporte-texto').innerText = 'No se pudo cargar el reporte estad√≠stico.';
                }
                
            } catch (error) {
                alert('No se pudo cargar la ficha del jugador.');
            }
        }

        if (idJugador) {
            cargarFicha();
            cargarKinesiologia(); // Se carga al entrar
        } else {
            alert('No se especific√≥ un jugador.');
            window.location.href = 'index.html';
        }

        // --- 3. EXPORTAR Y ELIMINAR JUGADOR ---
        function generarPDFyWhatsApp() {
            if(!jugadorActual) return;
            const titulosImpresion = document.querySelectorAll('.solo-impresion');
            titulosImpresion.forEach(el => el.style.display = 'block');
            const elementosPantalla = document.querySelectorAll('.solo-pantalla');
            elementosPantalla.forEach(el => el.style.display = 'none');

            const elemento = document.getElementById('area-pdf');
            const opciones = {
                margin: 0.5,
                filename: `Ficha_Medica_${jugadorActual.apellido}_${jugadorActual.nombre}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true }, 
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opciones).from(elemento).save().then(() => {
                titulosImpresion.forEach(el => el.style.display = 'none');
                elementosPantalla.forEach(el => el.style.display = ''); 
                setTimeout(() => {
                    alert('üìÑ ¬°El PDF se descarg√≥!\nSe va a abrir WhatsApp para que lo env√≠es.');
                    const texto = `Hola! Te env√≠o la ficha m√©dica de ${jugadorActual.nombre} ${jugadorActual.apellido}.`;
                    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`, '_blank');
                }, 500); 
            });
        }

        function compartirEmail() {
            if(!jugadorActual) return;
            const asunto = `Ficha M√©dica - ${jugadorActual.nombre} ${jugadorActual.apellido}`;
            const cuerpo = `Hola,\n\nAdjunto la ficha m√©dica de ${jugadorActual.nombre} ${jugadorActual.apellido}.\n\nSaludos.`;
            window.location.href = `mailto:?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
        }

        async function eliminarJugador() {
            if (!confirm(`‚ö†Ô∏è ¬øELIMINAR definitivamente a ${jugadorActual.nombre} ${jugadorActual.apellido}?`)) return;
            try {
                const respuesta = await fetch(`http://localhost:3000/jugadores/${idJugador}`, { method: 'DELETE' });
                if (respuesta.ok) {
                    alert('Jugador eliminado.');
                    window.location.href = 'index.html'; 
                } else alert('Error al eliminar.');
            } catch (error) { alert('No se pudo conectar.'); }
        }

        // --- 4. PERMISOS ---
        const rolUsuario = sessionStorage.getItem('usuarioRol');
        if (rolUsuario === 'Cuerpo Tecnico') {
            const btnEditar = document.querySelector('button[onclick*="editar.html"]');
            const btnEliminar = document.querySelector('button[onclick="eliminarJugador()"]');
            if (btnEditar) btnEditar.style.display = 'none';
            if (btnEliminar) btnEliminar.style.display = 'none';
        }
        if (rolUsuario === 'Administrativo') {
            const btnAgregarKine = document.getElementById('btn-agregar-kine');
            if (btnAgregarKine) btnAgregarKine.style.display = 'none';
        }

        // --- 5. ASISTENCIA ---
        function generarReporteAsistencia() {
            if (historialAsistencia.length === 0) {
                document.getElementById('f-reporte-texto').innerHTML = 'El jugador no tiene registros de asistencia.';
                return;
            }
            let tb=0, pb=0, tf=0, pf=0;
            historialAsistencia.forEach(a => {
                if (a.tipo_entrenamiento === 'Basquet') { tb++; if (a.estado === 'Presente') pb++; }
                else if (a.tipo_entrenamiento === 'Fisico') { tf++; if (a.estado === 'Presente') pf++; }
            });
            const pBasquet = tb > 0 ? Math.round((pb/tb)*100) : 0;
            const pFisico = tf > 0 ? Math.round((pf/tf)*100) : 0;
            document.getElementById('f-reporte-texto').innerHTML = `B√°squet: ${pb}/${tb} (${pBasquet}%). F√≠sico: ${pf}/${tf} (${pFisico}%).`;
        }

        function buscarAsistenciaPorDia() {
            const fechaBuscada = document.getElementById('buscador-fecha-asis').value;
            const cont = document.getElementById('resultado-busqueda-dia');
            if (!fechaBuscada) return cont.innerHTML = '<span class="text-danger small">Eleg√≠ una fecha.</span>';
            const registrosDelDia = historialAsistencia.filter(a => a.fecha.split('T')[0] === fechaBuscada);
            
            if (registrosDelDia.length === 0) return cont.innerHTML = '<span class="text-muted small">Sin registros.</span>';
            
            let htmlRes = '';
            registrosDelDia.forEach(reg => {
                let badgeClass = reg.estado === 'Presente' ? 'bg-success' : (reg.estado === 'Justificado' ? 'bg-warning text-dark' : 'bg-danger');
                const icono = reg.tipo_entrenamiento === 'Basquet' ? 'üèÄ' : 'üèãÔ∏è';
                htmlRes += `<div class="mb-1 fw-bold">${icono}: <span class="badge ${badgeClass} ms-2 px-3">${reg.estado}</span></div>`;
            });
            cont.innerHTML = htmlRes;
        }

        // --- 6. KINESIOLOG√çA BLINDADA ---
        document.getElementById('k-fecha').valueAsDate = new Date(); 

        async function cargarKinesiologia() {
            const tabla = document.getElementById('tabla-kinesiologia');
            try {
                const respuesta = await fetch(`http://localhost:3000/kinesiologia/${idJugador}`);
                historialKine = await respuesta.json(); 

                tabla.innerHTML = '';
                if (historialKine.length === 0) {
                    tabla.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Sin historial kinesiol√≥gico.</td></tr>';
                    return;
                }

                historialKine.forEach(reg => {
                    const fechaObj = new Date(reg.fecha);
                    fechaObj.setMinutes(fechaObj.getMinutes() + fechaObj.getTimezoneOffset());
                    const fechaStr = fechaObj.toLocaleDateString('es-AR');
                    const obsHtml = reg.observaciones ? `<br><small class="text-muted fst-italic">Obs: ${reg.observaciones}</small>` : '';

                    let botonesAccion = `<td></td>`;
                    if (sessionStorage.getItem('usuarioRol') !== 'Administrativo') {
                        // El bot√≥n de editar ahora solo ejecuta JavaScript puro, sin data-bs-toggle
                        botonesAccion = `
                            <td class="text-center">
                                <div class="btn-group shadow-sm">
                                    <button type="button" class="btn btn-outline-primary btn-sm" title="Editar Sesi√≥n" 
                                        onclick="abrirEdicionKine(${reg.id})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-sm" title="Eliminar Sesi√≥n" 
                                        onclick="eliminarKine(${reg.id})">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                    }

                    tabla.innerHTML += `
                        <tr>
                            <td class="fw-bold text-nowrap">${fechaStr}</td>
                            <td class="text-danger fw-bold">${reg.lesion_motivo}</td>
                            <td>${reg.tratamiento}${obsHtml}</td>
                            <td class="text-muted small"><i class="bi bi-person-badge"></i> ${reg.profesional_nombre}</td>
                            ${botonesAccion}
                        </tr>
                    `;
                });
            } catch (error) {
                tabla.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-3">Error al cargar.</td></tr>';
            }
        }

        // GUARDAR NUEVA SESI√ìN
        document.getElementById('form-kine').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nuevoReg = {
                jugador_id: idJugador,
                fecha: document.getElementById('k-fecha').value,
                lesion_motivo: document.getElementById('k-motivo').value,
                tratamiento: document.getElementById('k-tratamiento').value,
                observaciones: document.getElementById('k-observaciones').value,
                profesional_nombre: sessionStorage.getItem('usuarioLogueado') || 'Kinesi√≥logo'
            };
            try {
                const res = await fetch('http://localhost:3000/kinesiologia', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(nuevoReg)
                });
                if (res.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalKine')).hide();
                    document.getElementById('form-kine').reset();
                    document.getElementById('k-fecha').valueAsDate = new Date();
                    cargarKinesiologia();
                } else alert('‚ùå Error al guardar.');
            } catch (error) { alert('‚ùå Error de servidor.'); }
        });

        // ABRIR VENTANA DE EDICI√ìN
        function abrirEdicionKine(id) {
            const registro = historialKine.find(r => r.id === id);
            if (!registro) return;

            document.getElementById('edit-k-id').value = registro.id;
            
            // Convertimos la fecha de forma segura
            if (registro.fecha) {
                const d = new Date(registro.fecha);
                d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                document.getElementById('edit-k-fecha').value = `${year}-${month}-${day}`;
            }
            
            document.getElementById('edit-k-motivo').value = registro.lesion_motivo || '';
            document.getElementById('edit-k-tratamiento').value = registro.tratamiento || '';
            document.getElementById('edit-k-observaciones').value = registro.observaciones || '';

            // Abrir modal de forma pura y dura
            const modalEl = document.getElementById('modalEditarKine');
            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
            modalInstance.show();
        }

        // GUARDAR CAMBIOS DE EDICI√ìN
        document.getElementById('form-editar-kine').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-k-id').value;
            const act = {
                fecha: document.getElementById('edit-k-fecha').value,
                lesion_motivo: document.getElementById('edit-k-motivo').value,
                tratamiento: document.getElementById('edit-k-tratamiento').value,
                observaciones: document.getElementById('edit-k-observaciones').value
            };
            try {
                const res = await fetch(`http://localhost:3000/kinesiologia/${id}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(act)
                });
                if (res.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarKine')).hide();
                    cargarKinesiologia(); 
                } else alert('‚ùå Error al actualizar.');
            } catch (error) { alert('‚ùå Error de servidor.'); }
        });

        // ELIMINAR SESI√ìN
        async function eliminarKine(id) {
            if (!confirm('‚ö†Ô∏è ¬øELIMINAR definitivamente esta sesi√≥n?')) return;
            try {
                const res = await fetch(`http://localhost:3000/kinesiologia/${id}`, { method: 'DELETE' });
                if (res.ok) cargarKinesiologia(); 
                else alert('‚ùå Error al eliminar.');
            } catch (error) { console.error('Error:', error); }
        }
    </script>
</body>
</html>