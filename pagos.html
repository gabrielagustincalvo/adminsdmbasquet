<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesorer√≠a - Gesti√≥n Club üèÄ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .card-tesoreria { border-radius: 15px; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); }
    </style>
</head>
<body class="pb-5">

    <nav class="navbar navbar-expand-lg navbar-dark bg-success mb-4" style="background-color: #198754 !important;">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="bi bi-cash-coin"></i> Tesorer√≠a del Club
            </a>
            <div class="d-flex align-items-center text-white">
                <a href="index.html" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Volver al Inicio
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            
            <div class="col-lg-5 mb-4">
                <div class="card border-0 card-tesoreria h-100">
                    <div class="card-header bg-success text-white text-center py-3" style="border-radius: 15px 15px 0 0;">
                        <h4 class="mb-0 fw-bold">Registrar Nuevo Cobro</h4>
                    </div>
                    
                    <div class="card-body p-4">
                        <form id="form-pago">
                            
                            <div class="mb-3">
                                <label class="form-label text-muted fw-bold small">Seleccionar Jugador</label>
                                <select id="p-jugador" class="form-select border-success fw-bold" required onchange="cargarHistorial()">
                                    <option value="" selected disabled>Eleg√≠ un jugador...</option>
                                    </select>
                            </div>

                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label text-muted fw-bold small">Mes a abonar</label>
                                    <select id="p-mes" class="form-select bg-light" required>
                                        <option value="Enero">Enero</option>
                                        <option value="Febrero">Febrero</option>
                                        <option value="Marzo">Marzo</option>
                                        <option value="Abril">Abril</option>
                                        <option value="Mayo">Mayo</option>
                                        <option value="Junio">Junio</option>
                                        <option value="Julio">Julio</option>
                                        <option value="Agosto">Agosto</option>
                                        <option value="Septiembre">Septiembre</option>
                                        <option value="Octubre">Octubre</option>
                                        <option value="Noviembre">Noviembre</option>
                                        <option value="Diciembre">Diciembre</option>
                                    </select>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label text-muted fw-bold small">Fecha de Pago</label>
                                    <input type="date" id="p-fecha" class="form-control bg-light" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label text-muted fw-bold small">Monto ($)</label>
                                    <input type="number" id="p-monto" class="form-control border-success text-end fw-bold" required placeholder="Ej: 5000" min="0">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label text-muted fw-bold small">M√©todo de Pago</label>
                                    <select id="p-metodo" class="form-select bg-light" required>
                                        <option value="Efectivo">Efectivo üíµ</option>
                                        <option value="Transferencia">Transferencia üì±</option>
                                        <option value="MercadoPago">MercadoPago üí≥</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label text-muted fw-bold small">Observaciones (Opcional)</label>
                                <input type="text" id="p-observaciones" class="form-control bg-light" placeholder="Ej: Dej√≥ se√±a, pag√≥ hermano, etc.">
                            </div>

                            <button type="submit" class="btn btn-success w-100 fw-bold btn-lg shadow-sm">
                                <i class="bi bi-check-circle-fill"></i> Guardar Pago
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-7 mb-4">
                <div class="card border-0 card-tesoreria h-100">
                    <div class="card-header bg-dark text-white py-3" style="border-radius: 15px 15px 0 0;">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Historial de Pagos</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="px-4">Mes Abonado</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                        <th>M√©todo</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-historial">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-5">
                                            <i class="bi bi-arrow-left-circle fs-3 d-block mb-2"></i>
                                            Seleccion√° un jugador para ver sus pagos
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // 1. SEGURIDAD: Bloquear a profes (Cuerpo T√©cnico)
        const rolUsuario = sessionStorage.getItem('usuarioRol');
        if (!rolUsuario || rolUsuario === 'Cuerpo Tecnico') {
            alert('Acceso Denegado: Solo administraci√≥n puede ingresar a Tesorer√≠a.');
            window.location.href = 'index.html';
        }

        // Poner la fecha de hoy por defecto
        document.getElementById('p-fecha').valueAsDate = new Date();

        // 2. CARGAR LISTA DE JUGADORES EN EL SELECTOR
        async function cargarJugadoresSelect() {
            try {
                const respuesta = await fetch('http://localhost:3000/jugadores');
                const jugadores = await respuesta.json();
                
                // Ordenar alfab√©ticamente
                jugadores.sort((a, b) => a.apellido.localeCompare(b.apellido));

                const select = document.getElementById('p-jugador');
                jugadores.forEach(jugador => {
                    const option = document.createElement('option');
                    option.value = jugador.id;
                    option.text = `${jugador.apellido}, ${jugador.nombre} - ${jugador.rama || 'Masc'}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar jugadores:', error);
            }
        }

        // 3. CARGAR EL HISTORIAL CUANDO SE ELIGE UN JUGADOR
        async function cargarHistorial() {
            const jugador_id = document.getElementById('p-jugador').value;
            if (!jugador_id) return;

            const tabla = document.getElementById('tabla-historial');
            tabla.innerHTML = '<tr><td colspan="4" class="text-center py-4"><div class="spinner-border text-success" role="status"></div></td></tr>';

            try {
                const respuesta = await fetch(`http://localhost:3000/pagos/${jugador_id}`);
                const pagos = await respuesta.json();

                if (pagos.length === 0) {
                    tabla.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-4 fw-bold">No registra pagos cargados.</td></tr>';
                    return;
                }

                tabla.innerHTML = '';
                pagos.forEach(pago => {
                    // Formatear fecha a DD/MM/YYYY
                    const fechaObj = new Date(pago.fecha_pago);
                    // Sumamos un d√≠a para corregir el desfase de zona horaria de JS
                    fechaObj.setMinutes(fechaObj.getMinutes() + fechaObj.getTimezoneOffset());
                    const fechaFormat = fechaObj.toLocaleDateString('es-AR');

                    const fila = `
                        <tr>
                            <td class="px-4 fw-bold text-primary">${pago.mes_correspondiente}</td>
                            <td class="text-muted small">${fechaFormat}</td>
                            <td class="fw-bold text-success">$${Number(pago.monto).toLocaleString('es-AR')}</td>
                            <td><span class="badge bg-secondary">${pago.metodo}</span></td>
                        </tr>
                    `;
                    tabla.innerHTML += fila;
                });
            } catch (error) {
                console.error('Error al cargar historial:', error);
                tabla.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-4">Error al cargar datos.</td></tr>';
            }
        }

        // 4. GUARDAR UN PAGO NUEVO
        document.getElementById('form-pago').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nuevoPago = {
                jugador_id: document.getElementById('p-jugador').value,
                mes_correspondiente: document.getElementById('p-mes').value,
                fecha_pago: document.getElementById('p-fecha').value,
                monto: document.getElementById('p-monto').value,
                metodo: document.getElementById('p-metodo').value,
                observaciones: document.getElementById('p-observaciones').value
            };

            try {
                const respuesta = await fetch('http://localhost:3000/pagos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nuevoPago)
                });

                if (respuesta.ok) {
                    alert('‚úÖ ¬°Pago registrado exitosamente!');
                    // Limpiar monto y observaciones, dejar jugador y mes por si se carga otro
                    document.getElementById('p-monto').value = '';
                    document.getElementById('p-observaciones').value = '';
                    // Recargar la tablita del costado
                    cargarHistorial();
                } else {
                    alert('‚ùå Error al guardar el pago.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('No se pudo conectar con el servidor.');
            }
        });

        // Iniciar pantalla
        cargarJugadoresSelect();
    </script>
</body>
</html>