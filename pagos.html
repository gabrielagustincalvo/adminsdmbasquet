<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesorer√≠a - Gesti√≥n Club üèÄ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    
    <style>
        body { background-color: #f8f9fa; }
        .card-tesoreria { border-radius: 15px; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); }
    </style>
</head>
<body class="pb-5">

    <nav class="navbar navbar-expand-lg navbar-dark bg-success mb-4" style="background-color: #198754 !important;">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="bi bi-cash-coin"></i> Tesorer√≠a del Club
            </a>
            <div class="d-flex align-items-center text-white">
                <a href="index.html" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Volver al Inicio
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            
            <div class="col-lg-5 mb-4">
                <div class="card border-0 card-tesoreria h-100">
                    <div class="card-header bg-success text-white text-center py-3" style="border-radius: 15px 15px 0 0;">
                        <h4 class="mb-0 fw-bold">Registrar Nuevo Cobro</h4>
                    </div>
                    
                    <div class="card-body p-4">
                        <form id="form-pago">
                            
                            <div class="mb-3">
                                <label class="form-label text-muted fw-bold small">Seleccionar Jugador</label>
                                <select id="p-jugador" class="form-select border-success fw-bold" required></select>
                            </div>

                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label text-muted fw-bold small">Mes a abonar</label>
                                    <select id="p-mes" class="form-select bg-light" required>
                                        <option value="Enero">Enero</option>
                                        <option value="Febrero">Febrero</option>
                                        <option value="Marzo">Marzo</option>
                                        <option value="Abril">Abril</option>
                                        <option value="Mayo">Mayo</option>
                                        <option value="Junio">Junio</option>
                                        <option value="Julio">Julio</option>
                                        <option value="Agosto">Agosto</option>
                                        <option value="Septiembre">Septiembre</option>
                                        <option value="Octubre">Octubre</option>
                                        <option value="Noviembre">Noviembre</option>
                                        <option value="Diciembre">Diciembre</option>
                                    </select>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label text-muted fw-bold small">Fecha de Pago</label>
                                    <input type="date" id="p-fecha" class="form-control bg-light" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label text-muted fw-bold small">Monto ($)</label>
                                    <input type="number" id="p-monto" class="form-control border-success text-end fw-bold" required placeholder="Ej: 5000" min="0">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label text-muted fw-bold small">M√©todo de Pago</label>
                                    <select id="p-metodo" class="form-select bg-light" required>
                                        <option value="Efectivo">Efectivo üíµ</option>
                                        <option value="Transferencia">Transferencia üì±</option>
                                        <option value="MercadoPago">MercadoPago üí≥</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label text-muted fw-bold small">Observaciones (Opcional)</label>
                                <input type="text" id="p-observaciones" class="form-control bg-light" placeholder="Ej: Dej√≥ se√±a, pag√≥ hermano, etc.">
                            </div>

                            <button type="submit" class="btn btn-success w-100 fw-bold btn-lg shadow-sm">
                                <i class="bi bi-check-circle-fill"></i> Guardar Pago
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-7 mb-4">
                <div class="card border-0 card-tesoreria h-100">
                    <div class="card-header bg-dark text-white py-3" style="border-radius: 15px 15px 0 0;">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Historial de Pagos</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="px-4">Mes Abonado</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                        <th>M√©todo</th>
                                        <th>Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-historial">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-5">
                                            <i class="bi bi-arrow-left-circle fs-3 d-block mb-2"></i>
                                            Seleccion√° un jugador para ver sus pagos
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // 1. SEGURIDAD
        const rolUsuario = sessionStorage.getItem('usuarioRol');
        if (!rolUsuario || rolUsuario === 'Cuerpo Tecnico') {
            alert('Acceso Denegado: Solo administraci√≥n puede ingresar a Tesorer√≠a.');
            window.location.href = 'index.html';
        }

        document.getElementById('p-fecha').valueAsDate = new Date();

        // 2. CARGAR JUGADORES BLINDADO
        async function cargarJugadoresSelect() {
            try {
                const respuesta = await fetch('http://localhost:3000/jugadores');
                const jugadores = await respuesta.json();
                
                jugadores.sort((a, b) => a.apellido.localeCompare(b.apellido));

                const select = document.getElementById('p-jugador');

                // Iniciamos el buscador vac√≠o
                const buscador = new Choices(select, {
                    searchEnabled: true,
                    searchPlaceholderValue: 'üîç Buscar apellido...',
                    itemSelectText: 'Seleccionar',
                    noResultsText: 'No se encontraron jugadores',
                    shouldSort: false,
                    searchFields: ['label'],
                    fuseOptions: { threshold: 0.2, ignoreLocation: true }
                });

                // Armamos la lista asegurando que el ID sea texto (String)
                const opciones = [
                    { value: '', label: 'Eleg√≠ un jugador...', disabled: true, selected: true },
                    ...jugadores.map(j => ({
                        value: String(j.id), 
                        label: `${j.apellido}, ${j.nombre} - ${j.rama || 'Masc'}`
                    }))
                ];

                // Inyectamos y reemplazamos todo (true)
                buscador.setChoices(opciones, 'value', 'label', true);

                // Escuchamos el cambio de jugador para cargar su historial
                select.addEventListener('change', cargarHistorial);

            } catch (error) {
                console.error('Error al cargar jugadores:', error);
            }
        }

        // 3. CARGAR HISTORIAL
        async function cargarHistorial() {
            const jugador_id = document.getElementById('p-jugador').value;
            if (!jugador_id) return;

            const tabla = document.getElementById('tabla-historial');
            tabla.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-success"></div></td></tr>';

            try {
                const respuesta = await fetch(`http://localhost:3000/pagos/${jugador_id}`);
                const pagos = await respuesta.json();

                if (pagos.length === 0) {
                    tabla.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4 fw-bold">No registra pagos cargados.</td></tr>';
                    return;
                }

                tabla.innerHTML = '';
                pagos.forEach(pago => {
                    const fechaObj = new Date(pago.fecha_pago);
                    fechaObj.setMinutes(fechaObj.getMinutes() + fechaObj.getTimezoneOffset());
                    const fechaFormat = fechaObj.toLocaleDateString('es-AR');
                    const montoFormat = `$${Number(pago.monto).toLocaleString('es-AR')}`;

                    const fila = `
                        <tr>
                            <td class="px-4 fw-bold text-primary">${pago.mes_correspondiente}</td>
                            <td class="text-muted small">${fechaFormat}</td>
                            <td class="fw-bold text-success">${montoFormat}</td>
                            <td><span class="badge bg-secondary">${pago.metodo}</span></td>
                            <td>
                                <button type="button" class="btn btn-outline-dark btn-sm shadow-sm" title="Imprimir Recibo" 
                                    onclick="imprimirRecibo('${pago.mes_correspondiente}', '${fechaFormat}', '${montoFormat}', '${pago.metodo}')">
                                    <i class="bi bi-printer-fill"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tabla.innerHTML += fila;
                });
            } catch (error) {
                console.error('Error al cargar historial:', error);
                tabla.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Error de conexi√≥n.</td></tr>';
            }
        }

        // 4. GUARDAR PAGO
        document.getElementById('form-pago').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nuevoPago = {
                jugador_id: document.getElementById('p-jugador').value,
                mes_correspondiente: document.getElementById('p-mes').value,
                fecha_pago: document.getElementById('p-fecha').value,
                monto: document.getElementById('p-monto').value,
                metodo: document.getElementById('p-metodo').value,
                observaciones: document.getElementById('p-observaciones').value
            };

            try {
                const respuesta = await fetch('http://localhost:3000/pagos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nuevoPago)
                });

                if (respuesta.ok) {
                    alert('‚úÖ ¬°Pago guardado!');
                    document.getElementById('p-monto').value = '';
                    document.getElementById('p-observaciones').value = '';
                    cargarHistorial();
                } else {
                    alert('‚ùå Error al guardar.');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // 5. IMPRIMIR RECIBO
        function imprimirRecibo(mes, fecha, monto, metodo) {
            const selectJugador = document.getElementById('p-jugador');
            const textoCompleto = selectJugador.options[selectJugador.selectedIndex].text;
            const nombreJugador = textoCompleto.split(' - ')[0]; 

            const ventana = window.open('', '_blank', 'width=800,height=600');
            const html = `
                <html>
                <head>
                    <title>Recibo - Sol de Mayo</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; color: #333; }
                        .recibo-box { border: 2px solid #198754; border-radius: 12px; padding: 30px; max-width: 500px; margin: 0 auto; }
                        .header { text-align: center; border-bottom: 2px dashed #ccc; padding-bottom: 20px; margin-bottom: 20px; }
                        .header h2 { margin: 0; color: #198754; }
                        .detalle { font-size: 16px; line-height: 2; margin-top: 20px; }
                        .monto { font-size: 28px; text-align: center; background: #e8f5e9; padding: 15px; border-radius: 8px; color: #198754; font-weight: bold; margin: 25px 0; border: 1px solid #c8e6c9;}
                        .footer { text-align: center; margin-top: 40px; font-size: 13px; color: #777; border-top: 1px solid #eee; padding-top: 15px; }
                    </style>
                </head>
                <body>
                    <div class="recibo-box">
                        <div class="header">
                            <h2>üèÄ Club Atl√©tico Sol de Mayo</h2>
                            <p>COMPROBANTE OFICIAL DE PAGO</p>
                        </div>
                        <div class="detalle">
                            <strong>Fecha:</strong> ${fecha}<br>
                            <strong>Recibimos de:</strong> ${nombreJugador}<br>
                            <strong>Concepto:</strong> Cuota ${mes}<br>
                            <strong>M√©todo:</strong> ${metodo}
                        </div>
                        <div class="monto">TOTAL: ${monto}</div>
                        <div class="footer">¬°Gracias por acompa√±ar al club!</div>
                    </div>
                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `;
            ventana.document.write(html);
            ventana.document.close();
        }

        // Iniciar
        cargarJugadoresSelect();
    </script>
</body>
</html>