<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti칩n del Club 游</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card-categoria { transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; border-radius: 12px; }
        .card-categoria:hover { transform: translateY(-5px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
        .badge-rama { font-size: 0.8em; }

        /* Ajuste responsivo para los botones del men칰 */
        @media (max-width: 768px) {
            .botonera-mobile {
                width: 100%;
                margin-top: 10px;
            }
            .btn-responsivo {
                flex: 1 1 45% !important; /* Magia: ocupan mitad y mitad. Si queda uno solo en la fila, se estira al 100% */
                margin: 0 !important; /* Borra los m치rgenes de PC */
                text-align: center;
                font-size: 0.85rem;
                padding: 0.4rem 0.2rem;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 5px; /* Separaci칩n entre el 칤cono y el texto */
            }
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">游 Club Sol de Mayo Basquet</a>
            <div class="d-flex align-items-center text-white">
                <span class="me-3">Hola, <strong id="usuario-nombre">...</strong></span>
                <button onclick="cerrarSesion()" class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-center mb-4 gap-3">
            
            <div class="d-flex flex-wrap justify-content-center justify-content-lg-start align-items-center gap-3">
                <h2 id="titulo-pantalla" class="mb-0 fw-bold text-nowrap">Categor칤as</h2>
                
                <select id="filtro-rama" class="form-select bg-primary text-white fw-bold border-0 shadow-sm w-auto" onchange="cargarDashboard(); procesarHash();">
                    <option value="Todos">Ambas Ramas 游</option>
                    <option value="Femenino">Femenino 游릮</option>
                    <option value="Masculino">Masculino 游댯</option>
                </select>
            </div>
            
            <div class="d-flex flex-wrap justify-content-center justify-content-lg-end gap-2 botonera-mobile">
                <a href="alta.html" class="btn btn-success shadow-sm btn-responsivo">
                    <i class="bi bi-person-plus-fill"></i> Nuevo Jugador
                </a>
                <a href="asistencia.html" id="btn-asistencia" class="btn btn-primary shadow-sm btn-responsivo">
                    <i class="bi bi-clipboard-check"></i> Asistencia
                </a>
                <a href="registro.html" id="btn-crear-usuario" class="btn btn-warning shadow-sm text-dark fw-bold btn-responsivo">
                    <i class="bi bi-person-badge"></i> Nuevo Empleado
                </a>
                <a href="pagos.html" id="btn-tesoreria" class="btn btn-success shadow-sm fw-bold btn-responsivo" style="background-color: #198754;">
                    <i class="bi bi-cash-coin"></i> Tesorer칤a
                </a>

                <button onclick="window.location.hash = '#staff'" class="btn btn-info shadow-sm text-dark fw-bold btn-responsivo">
                    <i class="bi bi-person-lines-fill"></i> Staff
                </button>

            </div>

        </div>

        <div id="vista-dashboard" class="mb-5">
            <h4 class="mb-4 fw-bold text-secondary"><i class="bi bi-graph-up-arrow"></i> Radiograf칤a del Club</h4>
            
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white border-0 shadow-sm h-100" style="border-radius: 15px;">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-people-fill fs-1 me-3 opacity-50"></i>
                            <div>
                                <h6 class="card-title text-uppercase fw-bold mb-0">Total Jugadores</h6>
                                <h2 class="display-5 fw-bold mb-0" id="dash-jugadores">0</h2>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4" id="tarjeta-recaudacion">
                    <div class="card bg-success text-white border-0 shadow-sm h-100" style="border-radius: 15px;">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-piggy-bank-fill fs-1 me-3 opacity-50"></i>
                            <div>
                                <h6 class="card-title text-uppercase fw-bold mb-0">Recaudaci칩n</h6>
                                <h2 class="display-6 fw-bold mb-0" id="dash-recaudacion">$0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card bg-dark text-white border-0 shadow-sm h-100" style="border-radius: 15px;">
                        <div class="card-body d-flex align-items-center">
                            <i class="bi bi-person-badge-fill fs-1 me-3 opacity-50"></i>
                            <div>
                                <h6 class="card-title text-uppercase fw-bold mb-0">Staff T칠cnico</h6>
                                <h2 class="display-5 fw-bold mb-0" id="dash-staff">0</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-8">
                    <div class="card border-0 shadow-sm h-100 p-3" style="border-radius: 15px;">
                        <h6 class="fw-bold text-center text-muted mb-3">Jugadores por Categor칤a</h6>
                        <div style="position: relative; height: 320px; width: 100%;">
                            <canvas id="graficoCategorias"></canvas> 
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm h-100 p-3" style="border-radius: 15px;">
                        <h6 class="fw-bold text-center text-muted mb-3">Distribuci칩n por Rama</h6>
                        <div style="position: relative; height: 320px; width: 100%; display: flex; justify-content: center;">
                            <canvas id="graficoRamas"></canvas> 
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="vista-categorias" class="row g-4"></div>

        <div id="vista-jugadores" style="display: none;">
            <button class="btn btn-secondary mb-3 shadow-sm" onclick="window.location.hash = '#categorias'">
                <i class="bi bi-arrow-left"></i> Volver a Categor칤as
            </button>
            
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Jugador</th>
                                <th>Edad / A침o</th>
                                <th>Rama</th>
                                <th>Tel칠fono</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="lista-jugadores">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="vista-staff" style="display: none;">
            <button class="btn btn-secondary mb-3 shadow-sm" onclick="window.location.hash = '#categorias'">
                <i class="bi bi-arrow-left"></i> Volver a Categor칤as
            </button>
            
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Rol</th>
                                <th>Tel칠fono</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="lista-staff">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. SEGURIDAD
        const usuarioLogueado = sessionStorage.getItem('usuarioLogueado');
        if (!usuarioLogueado) window.location.href = 'login.html';
        else document.getElementById('usuario-nombre').innerText = usuarioLogueado;

        function cerrarSesion() {
            sessionStorage.removeItem('usuarioLogueado');
            sessionStorage.removeItem('usuarioRol');
            window.location.href = 'login.html';
        }

        let todosLosJugadores = [];
        let todosLosEmpleados = [];

        // 2. L칍GICA DE CATEGOR칈AS (Tus reglas exactas)
        function obtenerCategoria(fechaNacimiento) {
            if (!fechaNacimiento) return 'Sin Fecha';
            const anio = new Date(fechaNacimiento).getFullYear();
            
            if (anio >= 2019 && anio <= 2022) return 'Escuelita';
            if (anio === 2018 || anio === 2017) return 'Pre Mini';
            if (anio === 2016 || anio === 2015) return 'Mini (U11)';
            if (anio === 2014 || anio === 2013) return 'Infantiles (U13)';
            if (anio === 2012 || anio === 2011) return 'Cadetes (U15)';
            if (anio === 2010 || anio === 2009) return 'Juveniles (U17)';
            if (anio >= 2005 && anio <= 2008) return 'Liga Pr칩ximo (U21)';
            if (anio <= 2004) return 'Primera';
            return 'Otras'; // Por si anotas a alguien nacido en 2023 en adelante
        }

        // ==========================================
        // MOTOR DE NAVEGACI칍N SEGURO (CON HASH #)
        // ==========================================
        window.addEventListener('hashchange', procesarHash);

        function procesarHash() {
            const hash = window.location.hash || '#categorias';

            if (hash === '#staff') {
                verStaff();
            } else if (hash.startsWith('#jugadores-')) {
                const categoria = decodeURIComponent(hash.replace('#jugadores-', ''));
                verJugadores(categoria);
            } else {
                renderizarCategorias();
            }
        }


        // 4. DIBUJAR TARJETAS
        function renderizarCategorias() {
            document.getElementById('vista-jugadores').style.display = 'none';
            document.getElementById('vista-staff').style.display = 'none';
            document.getElementById('vista-dashboard').style.display = 'block'; 
            document.getElementById('vista-categorias').style.display = 'flex';
            
            document.getElementById('titulo-pantalla').innerText = 'Categor칤as';
            document.getElementById('filtro-rama').style.display = 'block'; // Volvemos a mostrar el filtro

            const ramaFiltro = document.getElementById('filtro-rama').value;
            const contenedor = document.getElementById('vista-categorias');
            contenedor.innerHTML = '';

            const agrupados = {};

            // Filtramos y agrupamos
            todosLosJugadores.forEach(jugador => {
                // Filtro por rama (si el jugador no tiene rama cargada, asumimos Masculino por defecto para que no desaparezca)
                const ramaJugador = jugador.rama || 'Masculino'; 
                if (ramaFiltro !== 'Todos' && ramaJugador !== ramaFiltro) return;

                const cat = obtenerCategoria(jugador.fecha_nacimiento);
                if (!agrupados[cat]) agrupados[cat] = [];
                agrupados[cat].push(jugador);
            });

            // Orden oficial para mostrar las tarjetas (de los m치s chicos a los m치s grandes)
            const ordenOficial = ['Escuelita', 'Pre Mini', 'Mini (U11)', 'Infantiles (U13)', 'Cadetes (U15)', 'Juveniles (U17)', 'Liga Pr칩ximo (U21)', 'Primera', 'Sin Fecha', 'Otras'];
            
            const categoriasPresentes = Object.keys(agrupados).sort((a, b) => ordenOficial.indexOf(a) - ordenOficial.indexOf(b));

            if (categoriasPresentes.length === 0) {
                contenedor.innerHTML = `<div class="col-12 text-center text-muted mt-5"><h4>No hay jugadores en esta rama.</h4></div>`;
                return;
            }

            // Dibujar las tarjetas
            categoriasPresentes.forEach(cat => {
                const cantidad = agrupados[cat].length;
                let colorBorde = cat === 'Primera' ? 'border-danger' : (cat.includes('U') ? 'border-warning' : 'border-success');

                const tarjeta = `
                    <div class="col-md-4 col-lg-3">
                        <div class="card h-100 shadow-sm card-categoria border-top border-4 ${colorBorde}" onclick="window.location.hash = '#jugadores-${cat}'">
                            <div class="card-body text-center">
                                <h4 class="card-title text-dark fw-bold mb-3">${cat}</h4>
                                <span class="badge bg-secondary rounded-pill px-3 py-2 fs-6">
                                    <i class="bi bi-people-fill"></i> ${cantidad} jugadores
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                contenedor.innerHTML += tarjeta;
            });
        }

        // 5. MOSTRAR TABLA DE UNA CATEGOR칈A
        function verJugadores(categoriaSeleccionada) {
            document.getElementById('vista-categorias').style.display = 'none';
            document.getElementById('vista-dashboard').style.display = 'none';
            document.getElementById('vista-staff').style.display = 'none';
            document.getElementById('vista-jugadores').style.display = 'block';
            
            document.getElementById('filtro-rama').style.display = 'block'; // Mostrar filtro
            
            const ramaFiltro = document.getElementById('filtro-rama').value;
            let textoRama = ramaFiltro === 'Todos' ? '' : ` (${ramaFiltro})`;
            document.getElementById('titulo-pantalla').innerText = `${categoriaSeleccionada}${textoRama}`;

            const tabla = document.getElementById('lista-jugadores');
            tabla.innerHTML = '';

            const filtrados = todosLosJugadores.filter(jugador => {
                const ramaJugador = jugador.rama || 'Masculino';
                const pasaFiltroRama = (ramaFiltro === 'Todos' || ramaJugador === ramaFiltro);
                return pasaFiltroRama && obtenerCategoria(jugador.fecha_nacimiento) === categoriaSeleccionada;
            });

            filtrados.forEach(jugador => {
                const edad = jugador.fecha_nacimiento ? `${new Date().getFullYear() - new Date(jugador.fecha_nacimiento).getFullYear()} a침os` : '-';
                const anioNac = jugador.fecha_nacimiento ? new Date(jugador.fecha_nacimiento).getFullYear() : '-';
                const ramaColor = (jugador.rama === 'Femenino') ? 'bg-purple' : 'bg-primary'; // Podes agregar CSS para bg-purple
                
                const fila = `
                    <tr>
                        <td>
                            <div class="fw-bold">${jugador.nombre} ${jugador.apellido}</div>
                            <div class="text-muted small">ID: #${jugador.id}</div>
                        </td>
                        <td>
                            <div>${edad}</div>
                            <div class="text-muted small">Clase ${anioNac}</div>
                        </td>
                        <td><span class="badge ${jugador.rama === 'Femenino' ? 'bg-danger' : 'bg-primary'} badge-rama">${jugador.rama || 'Masculino'}</span></td>
                        <td>${jugador.telefono || '-'}</td>
                        <td>
                            <a href="ficha.html?id=${jugador.id}" class="btn btn-outline-dark btn-sm">
                                <i class="bi bi-person-vcard"></i> Ficha
                            </a>
                        </td>
                    </tr>
                `;
                tabla.innerHTML += fila;
            });
        }

        function verStaff() {
            // Ocultamos las otras vistas y mostramos la del staff
            document.getElementById('vista-categorias').style.display = 'none';
            document.getElementById('vista-dashboard').style.display = 'none';
            document.getElementById('vista-jugadores').style.display = 'none';
            document.getElementById('vista-staff').style.display = 'block';
            
            document.getElementById('titulo-pantalla').innerText = 'Directorio del Staff';
            document.getElementById('filtro-rama').style.display = 'none'; // OCULTAMOS el filtro para ganar espacio

            const tabla = document.getElementById('lista-staff');
            tabla.innerHTML = '';

            todosLosEmpleados.forEach(emp => {
                // Le damos un color distinto a la etiqueta seg칰n el rol
                let badgeClass = 'bg-info text-dark';
                if (emp.rol === 'Admin Principal') badgeClass = 'bg-dark text-white';
                if (emp.rol === 'Cuerpo Tecnico') badgeClass = 'bg-warning text-dark';

                const fila = `
                    <tr>
                        <td>
                            <div class="fw-bold">${emp.nombre} ${emp.apellido}</div>
                            <div class="text-muted small">DNI: ${emp.dni || '-'}</div>
                        </td>
                        <td><span class="badge ${badgeClass}">${emp.rol}</span></td>
                        <td>${emp.telefono || '-'}</td>
                        <td>
                            <a href="ficha-empleado.html?id=${emp.id}" class="btn btn-outline-dark btn-sm">
                                <i class="bi bi-person-vcard"></i> Ficha
                            </a>
                        </td>
                    </tr>
                `;
                tabla.innerHTML += fila;
            });
        }

        // --- 3. INICIALIZAR EL PANEL (Carga datos y cura la amnesia) ---
        async function inicializarPanel() {
            try {
                // 1. Traemos jugadores y staff al mismo tiempo
                const resJug = await fetch('http://localhost:3000/jugadores');
                todosLosJugadores = await resJug.json();

                const resEmp = await fetch('http://localhost:3000/empleados');
                todosLosEmpleados = await resEmp.json();
                
                cargarDashboard();

                // Arrancamos el motor de Hash para saber d칩nde posicionarnos
                procesarHash();
            } catch (error) {
                console.error('Error al cargar datos:', error);
            }
        }

        // Ejecutamos la carga inteligente al abrir la p치gina
        inicializarPanel();

        // --- L칍GICA DE PERMISOS (ROLES) ---
        const rolUsuario = sessionStorage.getItem('usuarioRol');

        // NUEVO: Ocultamos el bot칩n de Asistencia a los Administrativos
        if (rolUsuario === 'Administrativo') {
            const btnAsistencia = document.getElementById('btn-asistencia');
            if (btnAsistencia) btnAsistencia.style.display = 'none';
        }

        // 1. Escondemos bot칩n de Nuevo Empleado a CUALQUIERA que no sea el Jefe
        const btnCrearUsuario = document.getElementById('btn-crear-usuario');
        if (btnCrearUsuario && rolUsuario !== 'Admin Principal') {
            btnCrearUsuario.style.display = 'none';
        }
        
        // Si es Cuerpo T칠cnico, le escondemos el resto de las herramientas administrativas
        if (rolUsuario === 'Cuerpo Tecnico') {
            // 2. Escondemos bot칩n de Alta de Jugadores
            const btnNuevoJugador = document.querySelector('a[href="alta.html"]');
            if (btnNuevoJugador) btnNuevoJugador.style.display = 'none';

            // 3. Escondemos bot칩n de Tesorer칤a
            const btnTesoreria = document.getElementById('btn-tesoreria');
            if (btnTesoreria) btnTesoreria.style.display = 'none';
        }

        // ==========================================
        // L칍GICA DEL DASHBOARD DE ESTAD칈STICAS (DIN츼MICO TOTAL)
        // ==========================================
        let chartRamas = null;
        let chartCategorias = null;

        async function cargarDashboard() {
            // 1. LEER EL FILTRO DE RAMA
            const selectRama = document.getElementById('filtro-rama');
            const ramaSeleccionada = selectRama ? selectRama.value : 'Todos';

            // Filtramos el arreglo de jugadores seg칰n lo que diga el select
            const jugadoresFiltrados = todosLosJugadores.filter(j => {
                if (!selectRama || ramaSeleccionada === 'Todos' || ramaSeleccionada === '') return true;
                const ramaJugador = j.rama || 'Masculino'; 
                return ramaJugador === ramaSeleccionada;
            });

            // 2. MOSTRAR N칔MEROS EN LAS TARJETAS (Usamos la lista filtrada)
            document.getElementById('dash-jugadores').innerText = jugadoresFiltrados.length;
            document.getElementById('dash-staff').innerText = todosLosEmpleados.length;

            // 3. RECAUDACI칍N DIN츼MICA POR RAMA
            const rolDash = sessionStorage.getItem('usuarioRol');
            if (rolDash === 'Cuerpo Tecnico') {
                const tarjetaReca = document.getElementById('tarjeta-recaudacion');
                if(tarjetaReca) tarjetaReca.style.display = 'none';
            } else {
                try {
                    // Traemos la lista detallada de TODOS los pagos (no solo el total)
                    const resPagos = await fetch('http://localhost:3000/pagos-todos');
                    const todosLosPagos = await resPagos.json();
                    
                    // Armamos una lista r치pida con los "ID" de los jugadores filtrados (Femenino o Masculino)
                    const idsFiltrados = jugadoresFiltrados.map(j => j.id);

                    // Sumamos la plata SOLO si el jugador due침o de ese pago est치 en nuestra lista filtrada
                    let sumaDinamica = 0;
                    todosLosPagos.forEach(pago => {
                        if (idsFiltrados.includes(pago.jugador_id)) {
                            sumaDinamica += Number(pago.monto);
                        }
                    });

                    // Mostramos la plata filtrada
                    document.getElementById('dash-recaudacion').innerText = `$${sumaDinamica.toLocaleString('es-AR')}`;
                } catch (e) { console.error("Error cargando pagos", e); }
            }

            // 4. GR츼FICO DE RAMAS (Torta)
            let masc = 0, fem = 0;
            jugadoresFiltrados.forEach(j => {
                if (j.rama === 'Femenino') fem++;
                else masc++;
            });

            if (chartRamas) chartRamas.destroy(); 
            chartRamas = new Chart(document.getElementById('graficoRamas'), {
                type: 'doughnut',
                data: {
                    labels: ['Masculino', 'Femenino'],
                    datasets: [{
                        data: [masc, fem],
                        backgroundColor: ['#0d6efd', '#dc3545'], // Azul y Rojo
                        borderWidth: 0
                    }]
                },
                options: { 
                    maintainAspectRatio: false, 
                    cutout: '70%', 
                    plugins: { legend: { position: 'bottom' } } 
                }
            });

            // 5. GR츼FICO DE CATEGOR칈AS (Barras)
            const conteoCat = {
                'Escuelita': 0, 'Pre Mini': 0, 'Mini (U11)': 0, 
                'Infantiles (U13)': 0, 'Cadetes (U15)': 0, 
                'Juveniles (U17)': 0, 'Liga Pr칩ximo (U21)': 0, 'Primera': 0
            };

            jugadoresFiltrados.forEach(j => {
                const cat = obtenerCategoria(j.fecha_nacimiento);
                if (conteoCat[cat] !== undefined) conteoCat[cat]++;
            });

            if (chartCategorias) chartCategorias.destroy();
            chartCategorias = new Chart(document.getElementById('graficoCategorias'), {
                type: 'bar',
                data: {
                    labels: Object.keys(conteoCat),
                    datasets: [{
                        label: 'Jugadores en esta categor칤a',
                        data: Object.values(conteoCat),
                        backgroundColor: '#198754', // Verde del club
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }, 
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 5 } } }
                }
            });
        }

        // ==========================================
        // FORZAR ACTUALIZACI칍N AL VOLVER ATR츼S
        // ==========================================
        window.addEventListener('pageshow', function(event) {
            const vieneDelHistorial = event.persisted || 
                                     (typeof window.performance != 'undefined' && 
                                      window.performance.navigation.type === 2);
            
            if (vieneDelHistorial) {
                window.location.reload(); 
            }
        });

    </script>
</body>
</html>