<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti칩n del Club 游</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .card-categoria { transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; border-radius: 12px; }
        .card-categoria:hover { transform: translateY(-5px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
        .badge-rama { font-size: 0.8em; }

        /* Ajuste responsivo para los botones del men칰 */
        @media (max-width: 768px) {
            .botonera-mobile {
                width: 100%;
                margin-top: 10px;
            }
            .btn-responsivo {
                flex: 1 1 45% !important; /* Magia: ocupan mitad y mitad. Si queda uno solo en la fila, se estira al 100% */
                margin: 0 !important; /* Borra los m치rgenes de PC */
                text-align: center;
                font-size: 0.85rem;
                padding: 0.4rem 0.2rem;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 5px; /* Separaci칩n entre el 칤cono y el texto */
            }
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">游 Club Sol de Mayo Basquet</a>
            <div class="d-flex align-items-center text-white">
                <span class="me-3">Hola, <strong id="usuario-nombre">...</strong></span>
                <button onclick="cerrarSesion()" class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="d-flex flex-column flex-xl-row justify-content-between align-items-center mb-4 gap-3">
            
            <div class="d-flex justify-content-center align-items-center gap-3">
                <h1 id="titulo-pantalla" class="mb-0">Categor칤as</h1>
                
                <select id="filtro-rama" class="form-select bg-primary text-white fw-bold border-0 shadow-sm w-auto" onchange="renderizarCategorias()">
                    <option value="Todos">Ambas Ramas 游</option>
                    <option value="Femenino">Femenino 游릮</option>
                    <option value="Masculino">Masculino 游댯</option>
                </select>
            </div>
            
            <div class="d-flex flex-wrap justify-content-center gap-2 botonera-mobile">
                <a href="alta.html" class="btn btn-success shadow-sm btn-responsivo">
                    <i class="bi bi-person-plus-fill"></i> Nuevo Jugador
                </a>
                <a href="asistencia.html" class="btn btn-primary shadow-sm btn-responsivo">
                    <i class="bi bi-clipboard-check"></i> Asistencia
                </a>
                <a href="registro.html" id="btn-crear-usuario" class="btn btn-warning shadow-sm text-dark fw-bold btn-responsivo">
                    <i class="bi bi-person-badge"></i> Nuevo Empleado
                </a>
                <a href="pagos.html" id="btn-tesoreria" class="btn btn-success shadow-sm fw-bold btn-responsivo" style="background-color: #198754;">
                    <i class="bi bi-cash-coin"></i> Tesorer칤a
                </a>
            </div>

        </div>
        
        <div id="vista-categorias" class="row g-4">
            </div>

        <div id="vista-jugadores" style="display: none;">
            <button class="btn btn-secondary mb-3 shadow-sm" onclick="volverACategorias()">
                <i class="bi bi-arrow-left"></i> Volver a Categor칤as
            </button>
            
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Jugador</th>
                                <th>Edad / A침o</th>
                                <th>Rama</th>
                                <th>Tel칠fono</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="lista-jugadores">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. SEGURIDAD
        const usuarioLogueado = sessionStorage.getItem('usuarioLogueado');
        if (!usuarioLogueado) window.location.href = 'login.html';
        else document.getElementById('usuario-nombre').innerText = usuarioLogueado;

        function cerrarSesion() {
            sessionStorage.removeItem('usuarioLogueado');
            window.location.href = 'login.html';
        }

        let todosLosJugadores = [];

        // 2. L칍GICA DE CATEGOR칈AS (Tus reglas exactas)
        function obtenerCategoria(fechaNacimiento) {
            if (!fechaNacimiento) return 'Sin Fecha';
            const anio = new Date(fechaNacimiento).getFullYear();
            
            if (anio >= 2019 && anio <= 2022) return 'Escuelita';
            if (anio === 2018 || anio === 2017) return 'Pre Mini';
            if (anio === 2016 || anio === 2015) return 'Mini (U11)';
            if (anio === 2014 || anio === 2013) return 'Infantiles (U13)';
            if (anio === 2012 || anio === 2011) return 'Cadetes (U15)';
            if (anio === 2010 || anio === 2009) return 'Juveniles (U17)';
            if (anio >= 2005 && anio <= 2008) return 'Liga Pr칩ximo (U21)';
            if (anio <= 2004) return 'Primera';
            return 'Otras'; // Por si anotas a alguien nacido en 2023 en adelante
        }

        // 3. CARGAR JUGADORES DESDE EL SERVIDOR
        async function cargarJugadores() {
            try {
                const respuesta = await fetch('http://localhost:3000/jugadores');
                todosLosJugadores = await respuesta.json();
                renderizarCategorias();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // 4. DIBUJAR TARJETAS
        function renderizarCategorias() {
            document.getElementById('vista-jugadores').style.display = 'none';
            document.getElementById('vista-categorias').style.display = 'flex';
            document.getElementById('titulo-pantalla').innerText = 'Categor칤as';

            const ramaFiltro = document.getElementById('filtro-rama').value;
            const contenedor = document.getElementById('vista-categorias');
            contenedor.innerHTML = '';

            const agrupados = {};

            // Filtramos y agrupamos
            todosLosJugadores.forEach(jugador => {
                // Filtro por rama (si el jugador no tiene rama cargada, asumimos Masculino por defecto para que no desaparezca)
                const ramaJugador = jugador.rama || 'Masculino'; 
                if (ramaFiltro !== 'Todos' && ramaJugador !== ramaFiltro) return;

                const cat = obtenerCategoria(jugador.fecha_nacimiento);
                if (!agrupados[cat]) agrupados[cat] = [];
                agrupados[cat].push(jugador);
            });

            // Orden oficial para mostrar las tarjetas (de los m치s chicos a los m치s grandes)
            const ordenOficial = ['Escuelita', 'Pre Mini', 'Mini (U11)', 'Infantiles (U13)', 'Cadetes (U15)', 'Juveniles (U17)', 'Liga Pr칩ximo (U21)', 'Primera', 'Sin Fecha', 'Otras'];
            
            const categoriasPresentes = Object.keys(agrupados).sort((a, b) => ordenOficial.indexOf(a) - ordenOficial.indexOf(b));

            if (categoriasPresentes.length === 0) {
                contenedor.innerHTML = `<div class="col-12 text-center text-muted mt-5"><h4>No hay jugadores en esta rama.</h4></div>`;
                return;
            }

            // Dibujar las tarjetas
            categoriasPresentes.forEach(cat => {
                const cantidad = agrupados[cat].length;
                let colorBorde = cat === 'Primera' ? 'border-danger' : (cat.includes('U') ? 'border-warning' : 'border-success');

                const tarjeta = `
                    <div class="col-md-4 col-lg-3">
                        <div class="card h-100 shadow-sm card-categoria border-top border-4 ${colorBorde}" onclick="verJugadores('${cat}')">
                            <div class="card-body text-center">
                                <h4 class="card-title text-dark fw-bold mb-3">${cat}</h4>
                                <span class="badge bg-secondary rounded-pill px-3 py-2 fs-6">
                                    <i class="bi bi-people-fill"></i> ${cantidad} jugadores
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                contenedor.innerHTML += tarjeta;
            });
        }

        // 5. MOSTRAR TABLA DE UNA CATEGOR칈A
        function verJugadores(categoriaSeleccionada) {
            document.getElementById('vista-categorias').style.display = 'none';
            document.getElementById('vista-jugadores').style.display = 'block';
            
            const ramaFiltro = document.getElementById('filtro-rama').value;
            let textoRama = ramaFiltro === 'Todos' ? '' : ` (${ramaFiltro})`;
            document.getElementById('titulo-pantalla').innerText = `${categoriaSeleccionada}${textoRama}`;

            const tabla = document.getElementById('lista-jugadores');
            tabla.innerHTML = '';

            const filtrados = todosLosJugadores.filter(jugador => {
                const ramaJugador = jugador.rama || 'Masculino';
                const pasaFiltroRama = (ramaFiltro === 'Todos' || ramaJugador === ramaFiltro);
                return pasaFiltroRama && obtenerCategoria(jugador.fecha_nacimiento) === categoriaSeleccionada;
            });

            filtrados.forEach(jugador => {
                const edad = jugador.fecha_nacimiento ? `${new Date().getFullYear() - new Date(jugador.fecha_nacimiento).getFullYear()} a침os` : '-';
                const anioNac = jugador.fecha_nacimiento ? new Date(jugador.fecha_nacimiento).getFullYear() : '-';
                const ramaColor = (jugador.rama === 'Femenino') ? 'bg-purple' : 'bg-primary'; // Podes agregar CSS para bg-purple
                
                const fila = `
                    <tr>
                        <td>
                            <div class="fw-bold">${jugador.nombre} ${jugador.apellido}</div>
                            <div class="text-muted small">ID: #${jugador.id}</div>
                        </td>
                        <td>
                            <div>${edad}</div>
                            <div class="text-muted small">Clase ${anioNac}</div>
                        </td>
                        <td><span class="badge ${jugador.rama === 'Femenino' ? 'bg-danger' : 'bg-primary'} badge-rama">${jugador.rama || 'Masculino'}</span></td>
                        <td>${jugador.telefono || '-'}</td>
                        <td>
                            <a href="ficha.html?id=${jugador.id}" class="btn btn-outline-dark btn-sm">
                                <i class="bi bi-person-vcard"></i> Ficha
                            </a>
                        </td>
                    </tr>
                `;
                tabla.innerHTML += fila;
            });
        }

        function volverACategorias() {
            renderizarCategorias();
        }

        cargarJugadores();

        // --- L칍GICA DE PERMISOS (ROLES) ---
        const rolUsuario = sessionStorage.getItem('usuarioRol');
        
        // 1. Si NO es el Admin Principal, escondemos el bot칩n amarillo de Crear Empleados
        if (rolUsuario !== 'Admin Principal') {
            const btnCrearUsuario = document.getElementById('btn-crear-usuario');
            if (btnCrearUsuario) btnCrearUsuario.style.display = 'none';
        }

        // 2. Si es Cuerpo T칠cnico, escondemos adem치s el bot칩n verde de Alta de Jugadores
        if (rolUsuario === 'Cuerpo Tecnico') {
            const btnNuevoJugador = document.querySelector('a[href="alta.html"]');
            if (btnNuevoJugador) {
                btnNuevoJugador.style.display = 'none';
            }
        }

        // 3. Si es Cuerpo T칠cnico, escondemos la B칩veda de Pagos (Tesorer칤a)
        if (rolUsuario === 'Cuerpo Tecnico') {
            const btnTesoreria = document.getElementById('btn-tesoreria');
            if (btnTesoreria) btnTesoreria.style.display = 'none';
        }

    </script>
</body>
</html>