<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Login - Club üèÄ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>body { background-color: #1e3c72; height: 100vh; display: flex; align-items: center; justify-content: center; }</style>
</head>
<body>
    <div class="card p-4 shadow-lg" style="width: 350px;" id="caja-login">
        <h3 class="text-center mb-3">üèÄ Login</h3>
        <form id="form-login">
            <div class="mb-3">
                <label>Usuario</label>
                <input type="text" id="usuario" class="form-control" required>
            </div>
            <div class="mb-3">
                <label>Contrase√±a</label>
                <input type="password" id="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Ingresar</button>
            <div class="text-center mt-3">
                <a href="recuperar.html" class="text-danger small fw-bold text-decoration-none">
                    ¬øOlvidaste tu contrase√±a o usuario?
                </a>
            </div>
        </form>
    </div>

    <div class="modal fade" id="modalPrimerIngreso" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold">‚ö†Ô∏è Primer Ingreso</h5>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted text-center mb-4">
                        Por motivos de seguridad, deb√©s elegir una <strong>nueva contrase√±a privada</strong> antes de entrar al sistema por primera vez.
                    </p>
                    <form id="form-cambio-pass">
                        <input type="hidden" id="usuario-id-temporal"> 
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nueva Contrase√±a</label>
                            <input type="password" id="nueva-pass-1" class="form-control" required minlength="6">
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">Repetir Contrase√±a</label>
                            <input type="password" id="nueva-pass-2" class="form-control" required minlength="6">
                            <small id="error-pass" class="text-danger d-none mt-1">Las contrase√±as no coinciden.</small>
                        </div>
                        <button type="submit" class="btn btn-danger w-100 fw-bold">Guardar y Entrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let datosUsuarioTemporal = null; // Para guardar los datos si debe cambiar la pass

        // L√ìGICA DE INGRESO
        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch('http://localhost:3000/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usuario, password })
                });

                const data = await res.json();
                
                if (res.ok) {
                    // BARRERA: ¬øEs su primer ingreso?
                    if (data.usuario.debe_cambiar_pass) {
                        // Guardamos temporalmente sus datos y su ID
                        datosUsuarioTemporal = data.usuario;
                        document.getElementById('usuario-id-temporal').value = data.usuario.id;
                        
                        // Escondemos la caja de login y mostramos la ventana obligatoria
                        document.getElementById('caja-login').style.display = 'none';
                        const modal = new bootstrap.Modal(document.getElementById('modalPrimerIngreso'));
                        modal.show();
                    } else {
                        // Si no es el primer ingreso, lo dejamos pasar normal
                        entrarAlSistema(data.usuario);
                    }
                } else {
                    alert('‚ùå ' + data.mensaje);
                }
            } catch (error) {
                alert('No se pudo conectar con el servidor.');
            }
        });

        // L√ìGICA DE GUARDAR LA NUEVA CLAVE
        document.getElementById('form-cambio-pass').addEventListener('submit', async (e) => {
            e.preventDefault();
            const p1 = document.getElementById('nueva-pass-1').value;
            const p2 = document.getElementById('nueva-pass-2').value;
            const idUsuario = document.getElementById('usuario-id-temporal').value;

            const msjError = document.getElementById('error-pass');

            // Validamos que sean iguales
            if (p1 !== p2) {
                msjError.classList.remove('d-none');
                return;
            }
            msjError.classList.add('d-none');

            try {
                const res = await fetch('http://localhost:3000/cambiar-password-obligatorio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: idUsuario, nuevaPassword: p1 })
                });

                if (res.ok) {
                    alert('‚úÖ Contrase√±a segura establecida. Bienvenido.');
                    // Como ya cambi√≥ la clave, lo dejamos pasar al sistema
                    entrarAlSistema(datosUsuarioTemporal);
                } else {
                    alert('Error al actualizar la contrase√±a.');
                }
            } catch (error) {
                alert('Error de conexi√≥n.');
            }
        });

        // FUNCI√ìN FINAL PARA DAR ACCESO
        function entrarAlSistema(usuarioObj) {
            sessionStorage.setItem('usuarioLogueado', usuarioObj.nombre);
            sessionStorage.setItem('usuarioRol', usuarioObj.rol);
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>